<?xml version="1.0" encoding="utf-8"?>
<!--
  Copyright 2018 Barroux Abbey (https://www.barroux.org/)
  @author: Alexis de Lattre <alexis.delattre@akretion.com>
  License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl).
-->

<odoo>


<record id="olive_arrival_form" model="ir.ui.view">
    <field name="name">olive.arrival.form</field>
    <field name="model">olive.arrival</field>
    <field name="arch" type="xml">
        <form string="Olive Arrival">
            <header>
                <button name="validate" string="Validate" class="btn-primary" states="draft" type="object"/>
                <button name="cancel" string="Cancel" class="btn-default" states="draft,done" confirm="Are you sure you want to cancel this arrival ?" type="object"/>
                <button name="back2draft" string="Back to Draft" class="btn-default" states="cancel" type="object"/>
                <field name="state" widget="statusbar" statusbar_visible="draft,done"/>
            </header>
            <sheet>
                <div class="oe_title">
                    <label for="name"/>
                    <h1>
                        <field name="name" readonly="1"/>
                    </h1>
                </div>
                <group name="main">
                    <group name="left">
                        <field name="partner_id"/>
                        <field name="commercial_partner_id" invisible="1"/>
                        <field name="partner_olive_culture_type" invisible="0"/>
                        <field name="default_ochard_id" domain="[('partner_id', '=', commercial_partner_id)]" context="{'default_partner_id': commercial_partner_id}"/>
                        <field name="default_variant_id" widget="selection"/>
                        <field name="default_oil_destination"/>
                        <field name="default_leaf_removal"/>
                    </group>
                    <group name="right">
                        <field name="date"/>
                        <label for="olive_qty" string="Total Quantity"/>
                        <div name="olive_qty">
                            <field name="olive_qty" class="oe_inline"/>
                            <label string=" kg"/>
                        </div>
                        <field name="returned_regular_case" attrs="{'readonly': ['|', ('partner_olive_culture_type', 'in', ('organic', 'conversion')), ('state', '=', 'done')]}"/>
                        <field name="returned_organic_case" attrs="{'readonly': ['|', ('partner_olive_culture_type', '=', 'regular'), ('state', '=', 'done')]}"/>
                        <field name="returned_palox_ids" widget="many2many_tags"
                            domain="[('borrower_partner_id', '=', commercial_partner_id)]"/>
                    </group>
                </group>
                <notebook>
                    <page name="lines" string="Arrival Lines">
                        <field name="line_ids" nolabel="1"
                            context="{'default_leaf_removal': default_leaf_removal, 'default_variant_id': default_variant_id, 'default_ochard_id': default_ochard_id, 'default_commercial_partner_id': commercial_partner_id, 'default_oil_destination': default_oil_destination, 'default_partner_olive_culture_type': partner_olive_culture_type, 'form_view_ref': 'olive_mill.olive_arrival_line_arrival_form'}">
                            <tree>
                                <field name="name"/>
                                <field name="olive_qty" sum="1"/>
                                <field name="leaf_removal"/>
                                <field name="variant_id" widget="selection"/>
                                <field name="ripeness"/>
                                <field name="sanitary_state"/>
                                <field name="oil_product_id"/>
                                <field name="ochard_id"/>
                                <field name="palox_id"/>
                                <field name="oil_destination"/>
                                <field name="mix_withdrawal_oil_qty" string="Withdrawal (L)" sum="1"/>
                                <field name="extra_count" string="Extras"/>
                            </tree>
                        </field>
                    </page>
                    <page name="additional" string="Additional Info">
                        <group name="tech">
                            <field name="warehouse_id"/>
                            <field name="season_id"/>
                            <field name="lended_case_id" context="{'olive_lended_case_main_view': True}"/>
                            <field name="done_datetime" states="done"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                        </group>
                    </page>
                </notebook>
            </sheet>
            <div class="oe_chatter">
                <field name="message_follower_ids" widget="mail_followers"/>
                <field name="message_ids" widget="mail_thread"/>
            </div>
        </form>
    </field>
</record>

<record id="olive_arrival_tree" model="ir.ui.view">
    <field name="name">olive.arrival.tree</field>
    <field name="model">olive.arrival</field>
    <field name="arch" type="xml">
        <tree string="Olive Arrivals" decoration-info="state == 'draft'" decoration-muted="state == 'cancel'">
            <field name="name"/>
            <field name="date"/>
            <field name="partner_id"/>
            <field name="commercial_partner_id" invisible="1"/>
            <field name="olive_qty" sum="1"/>
            <field name="state"/>
            <field name="company_id" groups="base.group_multi_company"/>
        </tree>
    </field>
</record>

<record id="olive_arrival_pivot" model="ir.ui.view">
    <field name="name">olive.arrival.pivot</field>
    <field name="model">olive.arrival</field>
    <field name="arch" type="xml">
        <pivot string="Olive Arrivals">
            <field name="commercial_partner_id" type="row"/>
            <field name="olive_qty" type="measure"/>
        </pivot>
    </field>
</record>

<record id="olive_arrival_graph" model="ir.ui.view">
    <field name="name">olive.arrival.graph</field>
    <field name="model">olive.arrival</field>
    <field name="arch" type="xml">
        <graph string="Olive Arrivals">
            <field name="date" type="row" interval="week"/>
            <field name="olive_qty" type="measure"/>
        </graph>
    </field>
</record>



<record id="olive_arrival_search" model="ir.ui.view">
    <field name="name">olive.arrival.search</field>
    <field name="model">olive.arrival</field>
    <field name="arch" type="xml">
        <search string="Search Olive Arrivals">
            <field name="name"/>
            <field name="partner_id" operator="child_of"/>
            <field name="warehouse_id"/>
            <separator/>
            <filter string="Draft" domain="[('state', '=', 'draft')]" name="draft"/>
            <filter string="Done" domain="[('state', '=', 'done')]" name="done"/>
            <filter string="Not Cancelled" domain="[('state', '!=', 'cancel')]" name="not_cancelled"/>
            <separator/>
            <filter name="today" string="Today" domain="[('date', '=', context_today().strftime('%Y-%m-%d'))]"/>
            <group string="Group By" name="groupby">
                <filter name="commercial_partner_groupby" string="Farmer" context="{'group_by': 'commercial_partner_id'}"/>
                <filter name="date_groupby" string="Date" context="{'group_by': 'date:week'}"/>
                <filter name="warehouse_groupby" string="Warehouse" context="{'group_by': 'warehouse_id'}"/>
                <filter name="season_groupby" string="Season" context="{'group_by': 'season_id'}"/>
                <filter name="state_groupby" string="State" context="{'group_by': 'state'}"/>
            </group>
        </search>
    </field>
</record>

<record id="olive_arrival_action" model="ir.actions.act_window">
    <field name="name">Arrivals</field>
    <field name="res_model">olive.arrival</field>
    <field name="view_mode">tree,form,pivot,graph</field>
    <field name="context">{'search_default_not_cancelled': 1}</field>
</record>

<menuitem id="olive_arrival_menu" action="olive_arrival_action" parent="olive_operations_menu" sequence="20"/>

<record id="olive_arrival_line_form" model="ir.ui.view">
    <field name="name">olive.arrival.line.form</field>
    <field name="model">olive.arrival.line</field>
    <field name="arch" type="xml">
        <form string="Olive Arrival Lines">
            <group name="main">
            <group name="main-left" string="Arrival">
                <field name="name"/>
                <field name="arrival_id"/>
                <field name="arrival_date"/>
                <field name="arrival_state"/>
                <field name="commercial_partner_id"/>
                <field name="partner_olive_culture_type"/>
                <label for="olive_qty" string="Olive Qty"/>
                <div name="olive_qty">
                    <field name="olive_qty" class="oe_inline"/>
                    <label string=" kg"/>
                </div>
                <field name="leaf_removal"/>
                <field name="variant_id" widget="selection"/>
                <field name="ripeness"/>
                <field name="sanitary_state"/>
                <field name="oil_product_id"
                   domain="[('olive_type', '=', 'oil'), ('olive_culture_type', '=', partner_olive_culture_type)]"/>
                <field name="ochard_id" domain="[('partner_id', '=', commercial_partner_id)]"/>
                <field name="palox_id" domain="['|', ('oil_product_id', '=', False), ('oil_product_id', '=', oil_product_id), '|', ('borrower_partner_id', '=', False), ('borrower_partner_id', '=', commercial_partner_id)]"/>
                <field name="oil_destination"/>
                <label for="mix_withdrawal_oil_qty" attrs="{'invisible': [('oil_destination', '!=', 'mix')]}" string="Requested Withdrawal Qty"/>
                <div name="mix_withdrawal_oil_qty" attrs="{'invisible': [('oil_destination', '!=', 'mix')]}">
                    <field name="mix_withdrawal_oil_qty"
                        attrs="{'required': [('oil_destination', '=', 'mix')]}" class="oe_inline"/>
                    <label string=" L"/>
                </div>
            </group>
            <group name="main-right" string="Production">
                <field name="production_id"/>
                <field name="production_date"/>
                <field name="production_state"/>
                <field name="compensation_type"/>
                <label for="oil_qty" string="Oil Qty"/>
                <div name="oil_qty">
                    <field name="oil_qty" class="oe_inline"/>
                    <label string=" L / " class="oe_inline"/>
                    <field name="oil_qty_kg" class="oe_inline"/>
                    <label string=" kg" class="oe_inline"/>
                </div>
                <label for="compensation_oil_qty" string="Compensation Oil Qty" attrs="{'invisible': [('compensation_type', 'not in', ('last', 'first'))]}"/>
                <div name="compensation_oil_qty" attrs="{'invisible': [('compensation_type', 'not in', ('last', 'first'))]}">
                    <field name="compensation_oil_qty" class="oe_inline"/>
                    <label string=" L"/>
                </div>
                <label for="shrinkage_oil_qty" string="Shrinkage Oil Qty"/>
                <div name="shrinkage_oil_qty">
                    <field name="shrinkage_oil_qty" class="oe_inline"/>
                    <label string=" L / " class="oe_inline"/>
                    <field name="shrinkage_oil_qty_kg" class="oe_inline"/>
                    <label string=" kg" class="oe_inline"/>
                </div>
                <label for="withdrawal_oil_qty" string="Withdrawal Oil Qty" attrs="{'invisible': [('oil_destination', 'not in', ('withdrawal', 'mix'))]}"/>
                <div name="withdrawal_oil_qty" attrs="{'invisible': [('oil_destination', 'not in', ('withdrawal', 'mix'))]}">
                    <field name="withdrawal_oil_qty" class="oe_inline"/>
                    <label string=" L / " class="oe_inline"/>
                    <field name="withdrawal_oil_qty_kg" class="oe_inline"/>
                    <label string=" kg" class="oe_inline"/>
                </div>
                <label for="filter_loss_oil_qty" string="Oil Qty Lost in Filter" attrs="{'invisible': [('oil_destination', 'not in', ('sale', 'mix'))]}"/>
                <div name="filter_loss_oil_qty" attrs="{'invisible': [('oil_destination', 'not in', ('sale', 'mix'))]}">
                    <field name="filter_loss_oil_qty" class="oe_inline"/>
                    <label string=" L" class="oe_inline"/>
                </div>
                <label for="to_sale_tank_oil_qty" string="Oil Qty to Sale Tank" attrs="{'invisible': [('oil_destination', 'not in', ('sale', 'mix'))]}"/>
                <div name="to_sale_tank_oil_qty" attrs="{'invisible': [('oil_destination', 'not in', ('sale', 'mix'))]}">
                    <field name="to_sale_tank_oil_qty" class="oe_inline"/>
                    <label string=" L" class="oe_inline"/>
                </div>
                <label for="sale_oil_qty" string="Oil Qty Sold" attrs="{'invisible': [('oil_destination', 'not in', ('sale', 'mix'))]}"/>
                <div name="sale_oil_qty" attrs="{'invisible': [('oil_destination', 'not in', ('sale', 'mix'))]}">
                    <field name="sale_oil_qty" class="oe_inline"/>
                    <label string=" L" class="oe_inline"/>
                </div>
                <label for="oil_ratio" string="Oil Gross Ratio"/>
                <div name="oil_ratio">
                    <field name="oil_ratio" class="oe_inline"/>
                    <label string=" % (L)" class="oe_inline"/>
                </div>
                <label for="oil_ratio_net" string="Oil Net Ratio"/>
                <div name="oil_ratio_net">
                    <field name="oil_ratio_net" class="oe_inline"/>
                    <label string=" % (L)" class="oe_inline"/>
                </div>
            </group>
            </group>
            <notebook>
                <page name="extras" string="Extra Items and Analysis">
                    <field name="extra_ids" nolabel="1"/>
                </page>
                <page name="other" string="Additional Information">
                    <group name="other_info">
                        <group name="other_stock">
                            <field name="season_id"/>
                            <field name="warehouse_id"/>
                            <field name="sale_move_id"/>
                            <field name="withdrawal_move_id"/>
                            <field name="compensation_last_move_id"/>
                        </group>
                        <group name="invoice">
                            <field name="out_invoice_id"/>
                            <field name="in_invoice_id"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                        </group>
                    </group>
                </page>
            </notebook>
        </form>
    </field>
</record>


<record id="olive_arrival_line_arrival_form" model="ir.ui.view">
    <field name="name">olive.arrival.line.extra_only.form</field>
    <field name="model">olive.arrival.line</field>
    <field name="priority">1000</field>
    <field name="arch" type="xml">
        <form string="Olive Arrival Line">
            <group name="main">
                <field name="name"/>
                <field name="commercial_partner_id" invisible="1"/>
                <field name="partner_olive_culture_type" invisible="1"/>
                <label for="olive_qty" string="Olive Qty"/>
                <div name="olive_qty">
                    <field name="olive_qty" class="oe_inline"/>
                    <label string=" kg"/>
                </div>
                <field name="leaf_removal"/>
                <field name="variant_id" widget="selection"/>
                <field name="ripeness"/>
                <field name="sanitary_state"/>
                <field name="oil_product_id"
                   domain="[('olive_type', '=', 'oil'), ('olive_culture_type', '=', partner_olive_culture_type)]"/>
                <field name="ochard_id" domain="[('partner_id', '=', commercial_partner_id)]"/>
                <field name="palox_id" domain="['|', ('oil_product_id', '=', False), ('oil_product_id', '=', oil_product_id), '|', ('borrower_partner_id', '=', False), ('borrower_partner_id', '=', commercial_partner_id)]"/>
                <field name="oil_destination"/>
                <label for="mix_withdrawal_oil_qty" attrs="{'invisible': [('oil_destination', '!=', 'mix')]}" string="Requested Withdrawal Qty"/>
                <div name="mix_withdrawal_oil_qty" attrs="{'invisible': [('oil_destination', '!=', 'mix')]}">
                    <field name="mix_withdrawal_oil_qty"
                        attrs="{'required': [('oil_destination', '=', 'mix')]}" class="oe_inline"/>
                    <label string=" L"/>
                </div>
            </group>
            <group name="extras" string="Extra Items and Analysis">
                <field name="extra_ids" nolabel="1"/>
            </group>
        </form>
    </field>
</record>


<record id="olive_arrival_line_tree" model="ir.ui.view">
    <field name="name">olive.arrival.line.tree</field>
    <field name="model">olive.arrival.line</field>
    <field name="arch" type="xml">
        <tree string="Olive Arrival Lines" decoration-info="arrival_state == 'draft'" decoration-muted="arrival_state == 'cancel'">
            <field name="name"/>
            <field name="arrival_id"/>
            <field name="production_id"/>
            <field name="commercial_partner_id"/>
            <field name="olive_qty" string="Olive Quantity (kg)"/>
            <field name="palox_id"/>
            <field name="oil_product_id"/>
            <field name="oil_ratio"/>
            <field name="oil_destination" string="Olive Quantity (kg)"/>
            <field name="arrival_state"/>
            <field name="production_state"/>
        </tree>
    </field>
</record>

<record id="olive_arrival_line_search" model="ir.ui.view">
    <field name="name">olive.arrival.line.search</field>
    <field name="model">olive.arrival.line</field>
    <field name="arch" type="xml">
        <search string="Search Arrival Lines">
            <field name="commercial_partner_id"/>
            <field name="season_id"/>
            <field name="warehouse_id"/>
            <separator/>
            <filter name="regular" string="Regular" domain="[('partner_olive_culture_type', '=', 'regular')]"/>
            <filter name="conversion" string="Conversion" domain="[('partner_olive_culture_type', '=', 'conversion')]"/>
            <filter name="organic" string="Organic" domain="[('partner_olive_culture_type', '=', 'organic')]"/>
            <separator/>
            <filter name="arrival_state_draft" string="Arrival Draft" domain="[('arrival_state', '=', 'draft')]"/>
            <filter name="arrival_state_done" string="Arrival Done" domain="[('arrival_state', '=', 'done')]"/>
            <filter name="arrival_state_cancel" string="Arrival Cancel" domain="[('arrival_state', '=', 'cancel')]"/>
            <group string="Group By" name="groupby">
                <filter name="commercial_partner_groupby" string="Partner" context="{'group_by': 'commercial_partner_id'}"/>
                <filter name="arrival_day_groupby" string="Arrival Day" context="{'group_by': 'arrival_date:day'}"/>
                <filter name="arrival_week_groupby" string="Arrival Week" context="{'group_by': 'arrival_date:week'}"/>
                <filter name="season_groupby" string="Season" context="{'group_by': 'season_id'}"/>
                <filter name="oil_destination_groupby" string="Oil Destination" context="{'group_by': 'oil_destination'}"/>
                <filter name="variant_groupby" string="Olive Variant" context="{'group_by': 'variant_id'}"/>
                <filter name="ochard_groupby" string="Ochard" context="{'group_by': 'ochard_id'}"/>
            </group>
        </search>
    </field>
</record>

<record id="olive_arrival_line_pivot" model="ir.ui.view">
    <field name="name">olive.arrival.line.pivot</field>
    <field name="model">olive.arrival.line</field>
    <field name="arch" type="xml">
        <pivot string="Olive Arrival Lines">
            <field name="arrival_date" interval="week" type="col"/>
            <field name="oil_product_id" type="row"/>
            <field name="olive_qty" type="measure"/>
            <field name="oil_qty" type="measure"/>
            <field name="withdrawal_oil_qty" type="measure"/>
            <field name="sale_oil_qty" type="measure"/>
        </pivot>
    </field>
</record>


<record id="partner_olive_arrival_line_pivot" model="ir.ui.view">
    <field name="name">olive.arrival.line.pivot</field>
    <field name="model">olive.arrival.line</field>
    <field name="priority">1000</field>
    <field name="arch" type="xml">
        <pivot string="Olive Arrival Lines">
            <field name="season_id" type="col"/>
            <field name="oil_product_id" type="row"/>
            <field name="olive_qty" type="measure"/>
            <field name="oil_qty" type="measure"/>
            <field name="withdrawal_oil_qty" type="measure"/>
            <field name="sale_oil_qty" type="measure"/>
        </pivot>
    </field>
</record>


<record id="olive_arrival_line_graph" model="ir.ui.view">
    <field name="name">olive.arrival.line.graph</field>
    <field name="model">olive.arrival.line</field>
    <field name="arch" type="xml">
        <graph string="Olive Arrival Lines">
            <field name="arrival_date" type="row" interval="week"/>
            <field name="olive_qty" type="measure"/>
        </graph>
    </field>
</record>

<record id="olive_arrival_line_action" model="ir.actions.act_window">
    <field name="name">Arrival Lines</field>
    <field name="res_model">olive.arrival.line</field>
    <field name="view_mode">tree,form,pivot,graph</field>
    <field name="context">{'search_default_arrival_state_done': True}</field>
</record>

<menuitem id="olive_arrival_line_menu" action="olive_arrival_line_action" parent="olive_report_menu" sequence="10" groups="stock.group_stock_manager"/>  <!-- maybe we will remove group once appropriate prodections are setup -->

<record id="olive_arrival_line_extra_tree" model="ir.ui.view">
    <field name="name">olive.arrival.line.extra.tree</field>
    <field name="model">olive.arrival.line.extra</field>
    <field name="arch" type="xml">
        <tree editable="bottom">
            <field name="product_id"/>
            <field name="product_olive_type" invisible="1"/>
            <field name="qty"/>
            <field name="uom_id" groups="product.group_uom"/>
            <field name="fillup"/>
        </tree>
    </field>
</record>




</odoo>
